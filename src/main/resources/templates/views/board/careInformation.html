<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>간병백과 (사용자)</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <link href="css/careInformation.css" rel="stylesheet" type="text/css"> -->
	<link th:href="@{css/footer.css}" rel="stylesheet" type="text/css"/>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
	<style>
		#careInfomationContainer{display:grid; grid-template-columns:1fr 1280px 1fr;}
	</style>
</head>
<body>
	<div th:replace="~{common/navbar :: navbar}"></div>
	
	<br/><br/><br/><br/><br/>
	
	<div id="careInfomationContainer">
		<div><!-- 왼쪽 공백 --></div>
	
		<div>
			<div id="upperContents" style="display:grid; grid-template-columns: 700px 1fr 400px;">
				<div id="searchContents" style="display:grid; grid-template-columns: 200px 200px 100px 100px;">
					<select class="form-select" name="searchOption">
						<option value="none">검색 유형 선택</option>
						<option value="title">제목</option>
						<option value="content">내용</option>
					</select>
					
					<input type="search" class="form-control" name="searchContent"/>
					<button class="btn btn-primary" type="button" id="searchBtn">검색하기</button>
					<button class="btn btn-warning" type="button" id="selectAllBtn">전체보기</button>
				</div>
				<div><!-- 공백 --></div>
				<div class="text-end">
					<a title="일반형 게시판 보기" href="careInformation.bo"><img src="image/icon/boardIcon.png" id="boardIcon" width="60px" height="60px" alt="일반 게시판"></a>
					<a title="앨범형 게시판 보기" href="albumCareInformation.bo"><img src="image/icon/albumIcon.png" id="albumIcon" alt="앨범형 게시판"></a>
				</div>
			</div>
			<table class="table table-hover">
				<thead>
					<tr>
						<th>글번호</th>
						<th>글제목</th>
						<th>작성일</th>
						<th>조회수</th>
					</tr>
				</thead>
				<tbody>
					<!-- 컨텐츠 목록 출력 공간 -->
				</tbody>
			</table>
		
		</div>
	
		<div><!-- 오른쪽 공백 --></div>
	</div>
	
	<!--  -->
	<!-- 간병백과 조회용 Scrollable modal (시작) -->
	<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
		    <div class="modal-content">
		    	<div class="modal-header">
			        <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		        </div>
			    <div class="modal-body">
			    	<div class="modal-dialog modal-dialog-scrollable" id="modalContent">
			        
			        </div>
			    </div>
			    <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
			        <!-- <button type="button" class="btn btn-primary">확인</button> -->
			    </div>
		    </div>
		</div>
	</div>
	<!-- 간병백과 조회용 Scrollable modal (끝) -->
	
	
	<!-- 검색결과 없을 때 openai 호출확인 Modal (시작)-->
	<div class="modal fade" id="confirmModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		    <div class="modal-content">
			    <div class="modal-header">
			        <h5 class="modal-title" id="confirmModalLabel">검색결과가 존재하지 않습니다.</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			    </div>
		      <div class="modal-body" id="confirmModalBody">
		        
		      </div>
		      <div class="modal-footer">
		      	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		      	<input type="hidden"/>
		      	<button type="button" class="btn btn-primary" id="confirmYes">추가검색</button>
		      </div>
		    </div>
		</div>
	</div>
	<!-- 검색결과 없을 때 openai 호출확인 Modal (끝)-->
	
	<!-- openai 답변용 모달 (시작) -->
	<div class="modal fade" id="answerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="answerModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		    <div class="modal-content">
		    	<div class="modal-header">
			        <h1 class="modal-title fs-5" id="answerModalLabel"></h1>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		        </div>
			    <div class="modal-body">
			    	<div class="modal-dialog modal-dialog-scrollable" id="answerModalContent">
			        
			        </div>
			    </div>
			    <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
			        <!-- <button type="button" class="btn btn-primary">확인</button> -->
			    </div>
		    </div>
		</div>
	</div>
	<!-- openai 답변용 모달 (끝) -->
	
	<div id="footer-section">
	    <div class="inner">
	        <div class="footer-logo">
	            <a href="home.do"><img th:src="@{/image/logo-removebg.png}" alt="로고" id="footer-logo"></a>
	        </div>
	        <div class="column-wrap d-flex">
		        <div class="footer-column">
		            <h3>Project</h3>
		            <p>Title</p>
		            <h6>DnDnCare</h6> 
		            <p>Tell</p>              
		            <h6>02-6959-2159</h6>
		            <p>Address</p>
		            <h6>서울특별시 중구 남대문로 120</h6>
		        </div>
		        <div class="footer-column">
		            <h3>Team Member</h3>
		            <h4>김명훈</h4>               
		            <h4>김종규</h4>
		            <h4>김기룡</h4>  
		            <h4>김남희</h4>
		            <h4>이재영</h4>
		        </div>
		        <div class="footer-column">
		           <h3>Project Info</h3>
				   <h6>KH정보교육원 JAVA개발자 양성 과정</h6>
				   <h6>Final Project</h6>
				   <h6>2024.07.29 - 2024.09.03</h6>
				   <h6>Java, SpringBoot, Oracle, JavaScript</h6>
		        </div>
	        </div>
	        
	    </div>
	    <div class="footer-bottom">
	        <p class="text-center">&copy; 2024 HomeWork. All rights reserved.</p>
	    </div>             
	</div>
	
	<div id="obsTarget"></div>
	
	<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script> -->
	<script th:inline="javascript">
		// 출력중인 게시글에 대한 정보를 저장해둘 변수를 선언 (시작)
		let presentBoardList = [];
		let presentAttmList = [];
		// 출력중인 게시글에 대한 정보를 저장해둘 변수를 선언 (끝)
		
		// ready 함수 작성
		window.onload = () => {
			const tbody = document.querySelector('tbody'); // 조회결과를 삽입할 요소에 접근
			let defaultPage = 1; // 검색X일 때 사용할 page변수 선언 및 초기화
			let defaultMaxPage; // 검색X일 때 최대 페이지의 수를 저장할 변수 선언
			let searchPage = 1; // 검색O일 때 사용할 page변수 선언 및 초기화
			let searchMaxPage; // 검색O일 때 최대 페이지의 수를 저장할 변수 선언
			let searchFlag = false; // 검색 조회인지 기본 조회인지를 구분하기 위한 깃발 꽂기
			
			// 기본 조회 요청(시작)
			const defaultList = (page) => {
				searchFlag = false;
				$.ajax({
					url: 'selectCareInformationList.bo',
					type: 'post',
					datatype: 'json',
					data: {page: page},
					success: data => {
						//console.log(data); // Object
						if(data != null){
							searchFlag = false;
							let aList = data.aList;
							presentAttmList = [];
							presentAttmList = presentAttmList.concat(aList);
							let bList = data.bList;
							presentBoardList = [];
							presentBoardList = presentBoardList.concat(bList);
							defaultMaxPage = data.pList[0];
							
							// 요소.insertAdjacentHTML() : 보안강화를 위한 연습하기
							for(const board of bList){ // 글번호, 글제목, 작성자, 조회수 를 출력해야한다.
								tbody.insertAdjacentHTML('beforeend', `<tr><td>${board.boardNo}</td><td>${board.boardTitle}</td><td>${board.boardUpdateDate}</td><td>${board.boardCount}</td></tr>`);
							}
							defaultPage++; // 다음 페이지의 숫자를 가르키도록 증가시키기
						}
					},
					error: data => console.log(data)
				});
			}
			// 기본 조회 요청(끝)
			
			// 페이지 처음 방문 시 출력할 목록 조회(시작)
			defaultList(defaultPage); // 페이지 로드시에 기본으로 실행되어야함
			// 페이지 처음 방문 시 출력할 목록 조회(끝)
			
			// 콜백함수 정의(시작)
			const callback = (entries, observer) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						if(!searchFlag && defaultPage <= defaultMaxPage) {
							console.log("일반조회 플래그 : " + searchFlag);
							defaultList(defaultPage); // 기본목록 조회 요청
							console.log("일반조회 요청 페이지 : " + defaultPage);
						} else if(searchFlag && searchPage <= searchMaxPage){
							console.log("검색조회 플래그 : " + searchFlag);
							searchList(searchPage); // 검색목록 조회 요청
							console.log("검색조회 요청 페이지 : " + searchPage);
						}
					}
				});
			}
			// 콜백함수 정의(끝)
			
			// 옵저버 정의 (시작)
			const obsTarget = document.querySelector('#obsTarget');// 관찰 대상을 지정
			let observer = new IntersectionObserver(callback);
			observer.observe(obsTarget);
			// 옵저버 정의 (끝)
		//}
		
		//window.onload = () => {
			//const tbody = document.querySelector('tbody');
			
			tbody.addEventListener('mouseover', function() { // 컨텐츠 목록에 마우스 오버시 손가락 포인터로 변경
				if(tbody.children[0].children[0].innerText != '검색결과가 존재하지 않습니다.'){
					this.style.cursor = 'pointer';
				}
			})
			
			
			const modalTitle = document.querySelector('#staticBackdropLabel'); // 글 상세조회 모달의 제목 요소에 접근
			const modalContent = document.querySelector('#modalContent'); // 글 상세조회 모달의 내용 요소에 접근
			
			tbody.addEventListener('click', function(event) { // 컨텐츠 목록을 마우스 클릭할 때 게시글 정보를 모달창으로 출력하자
				// 해당 글 번호에 접근 => 글 번호가 일치하는 정보에 접근 => 데이터 뿌리기
				
				//this.children[0].style.background = 'red'; // 여기여기 문제발생!
				//this.children[0].children[0].style.background = 'red'; // **
				//console.log(this);
				
				const bNo = event.target.parentElement.children[0].innerText;
				let bCountTd = event.target.parentElement.children[3];
				let clickBoard; // 클릭한 글에 대한 데이터에 접근
				const clickNoThumbNailList = []; // 클릭한 글에 대한 첨부파일에 접근
				let clickThumbnail; // 클릭한 글에 대한 썸네일을 저장할 지역변수
				
				for(const board of presentBoardList){
					if(board.boardNo == bNo) {
						clickBoard = board;
						break;
					}
				}
				
				for(const attm of presentAttmList){
					if(attm.refBoardNo == bNo){
						if(attm.attmLevel != 0) {
							clickNoThumbNailList.push(attm);
						} else{
							clickThumbnail = attm;
						}
					}
				}
				
				
				// 조회수 증가 : 로그인한 유저와 글 작성자가 다를 때만 동작해야 한다. (시작)
				/*<![CDATA[*/
				if(/*[[session.loginUser.memberNo]]*/0 != clickBoard.memberNo){
					//console.log(tbody.children[0].children[0].innerText);
					if(tbody.children[0].children[0].innerText != '검색결과가 존재하지 않습니다.'){
						$.ajax({
							url: 'updateCareInformationCount.bo',
							data: {boardNo: clickBoard.boardNo},
							success: data => {
								console.log(data);
								
								if(data == 'success'){ // 조회수 증가 성공 : 현재 View에서 조회수를 업데이트해야 한다.
									// table에서 해당 글에 대한 tr에 접근 => 조회수 +1 시키자.
									for(const present of presentBoardList){
										if(present.boardNo == bNo){ // 클릭한 글에 대한 정보를 전역변수에서 최신화한다.
											present.boardCount += 1; 
											bCountTd.innerText = present.boardCount; 
											break;
										}
									}
								} else{
									alert('서비스 요청에 실패하였습니다.');
									location.reload();
								}
							},
							error: data => console.log(data)
						});
						
						modalTitle.innerText = clickBoard.boardTitle;
						
						modalContent.innerHTML = '';
						if(clickThumbnail != undefined) {
							modalContent.insertAdjacentHTML('afterbegin', `<img src=${clickThumbnail.renameName}><br/>`);
						}
						modalContent.insertAdjacentHTML('beforeend', clickBoard.boardContent);
						
						$('#staticBackdrop').modal('show'); 
					}
				}
				/*]]>*/
				// 조회수 증가 (끝)
			})
			
			
			// 앨범형 아이콘 클릭(시작) : 컨텐츠 출력하는 구조가 달라지기 때문에 별도의 페이지로 제작하는 것이 안전할 것이라고 생각됨
			// 앨범형 아이콘 클릭(끝)
			
			
			// 검색 요청 함수 정의(시작)
			/*<![CDATA[*/
			let aiCount = /*[[${aiCount}]]*/'aiCount';	 // 사용자의 ai검색 요청 횟수
			/*]]>*/	
			const searchOption = document.getElementsByName('searchOption')[0];
			const optionList = searchOption.children;
			const searchContent = document.getElementsByName('searchContent')[0];
			
			const searchList = (page) => {
				searchFlag = true;
				$.ajax({
					url: 'searchCareInformation.bo',
					datatype: 'json',
					data: {
						searchOption: searchOption.value,
						searchContent: searchContent.value,
						page: page
					},
					success: data => {
						console.log("검색한 data :");
						console.log(data);
						if(data != null && data != 'empty'){
							let aList = data.aList;
							presentAttmList = [];
							presentAttmList = presentAttmList.concat(aList);
							let bList = data.bList;
							presentBoardList = [];
							presentBoardList = presentBoardList.concat(bList);
							searchMaxPage = data.pList[0];
							
							// 요소.insertAdjacentHTML() : 보안강화를 위한 연습하기
							tbody.innerHTML = '';
							for(const board of bList){ // 글번호, 글제목, 작성자, 조회수 를 출력해야한다.
								tbody.insertAdjacentHTML('beforeend', `<tr><td>${board.boardNo}</td><td>${board.boardTitle}</td><td>${board.boardUpdateDate}</td><td>${board.boardCount}</td></tr>`);
							}
							
							searchPage++;
						} else if(data == 'empty'){
							tbody.innerHTML = '';
							tbody.insertAdjacentHTML('beforeend', `<tr><td>검색결과가 존재하지 않습니다.</td><td></td><td></td><td></td></tr>`);
							
							let codition = searchOption.value == 'title' ? '제목' : '내용';
							document.querySelector('#confirmModalBody').innerHTML = `<span style="color: red;">'${codition}'</span>이 <span style="color: red;">'${searchContent.value}'</span>인 글이 존재하지 않습니다.<br/>Ai에게 질문하시겠습니까?<span style="color: red;">(${3-aiCount}회 남음)</span>`;
							document.querySelector('#confirmYes').previousElementSibling.value = searchContent.value;
							if(aiCount >= 3) {
								document.querySelector('#confirmYes').disabled = true; // 검색횟수가 3회이상일 때는 추가검색 버튼을 비활성화
							}
							
							$('#confirmModal').modal('show');
						}
					},
					error: data => console.log(data)
				});
			}
			// 검색 요청 함수 정의(끝)
			
			
			// 검색 기능 (시작)
			document.querySelector('#searchBtn').addEventListener('click', () => {
				if(optionList[0].selected){ // 검색옵션을 선택하지 않은 상태일 때
					searchContent.value = ''; // 검색내용을 초기화
					alert('검색 유형을 선택해주세요.'); 
				} else if(searchContent.value.trim() == ''){ // 검색내용을 입력하지 않은 상태일 때
					searchContent.value = ''; // 검색내용을 초기화
					alert('검색 내용을 입력해주세요.');
				} else { // 검색 옵션을 선택하고 검색내용을 입력한 상태일 때
					searchPage = 1; // 반복하여 검색했을 때 페이지의 수를 1로 초기화해야 한다.
					searchList(searchPage);
				}
			});
			// 검색 기능 (끝)
			
			// 전체보기 버튼 기능 (시작)
			document.querySelector('#selectAllBtn').addEventListener('click', () => {
				defaultPage = 1;
				defaultList(defaultPage);
			});
			// 전체보기 버튼 기능 (끝)
			
			// ai추가 검색 (시작)
			document.querySelector('#confirmYes').addEventListener('click', function() {
				aiCount++;
				
				let condition = this.previousElementSibling.value;
				$.ajax({
					url: 'searchOpenAi.bo',
					data: {condition: condition},
					success: data => {
						console.log(data);
						
						document.querySelector('#answerModalLabel').insertAdjacentHTML('afterbegin', `${condition}에 대한 AI 검색결과`);
						document.querySelector('#answerModalContent').insertAdjacentHTML('afterbegin', data);
						$('#confirmModal').modal('hide');
						$('#answerModal').modal('show');
					},
					error: data => console.log(data)
				});
			});
			// ai추가 검색 (끝)
			
		}
	</script>
</body>
</html>