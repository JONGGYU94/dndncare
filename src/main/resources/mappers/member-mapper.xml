<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kh.dndncare.member.model.dao.MemberMapper">

	<!-- <select id="login" resultType="Member">
		select *
	 	from member
	 	where member_status = 'N' and member_id=#{memberId}
	</select> -->
	
	  <select id="login" resultType="Member">
	  	select *
	  	from member
	  	where member_status = 'N' and member_id=#{memberId}
	  </select>
	  
	  
	  <!-- 회원가입 중도탈출 멤버 데이터 삭제 -->
	  <update id="noInfomemberdle">
	  	update member
	  	set member_status = 'Y'
	  	where member_no NOT IN (select member_no from caregiver union select member_no from patient)	 
	  			and member_category != 'A'
	  </update>
	  	  
	  
	  <!-- 아이디 중복 확인 -->
	  <select id="idCheck" resultType="_int">
	  	select count(*)
	  	from member
	  	where member_id = #{id}	  
	  </select>
	  
	  <!-- 닉네임 중복 확인 -->
	  <select id="nickNameCheck" resultType="_int">
	  	select count(*)
	  	from member
	  	where member_nickname = #{nickNameCheck}	  
	  </select>
	  
	  
	  

	<!-- ResultMap : 캘린더에 적합도록 매핑 -->
	<resultMap type="CalendarEvent" id="calendarResultMap">
		<id column="MAT_NO" property="matNo"/>
	  	<result column="TITLE" property="title"/>
		<result column="BEGIN_DT" property="start"/>
		<result column="END_DT" property="end"/>
		<result column="MONEY" property="money"/>
		<result column="HOSPITAL_NO" property="hosptialNo"/>
		<result column="HOSPITAL_ADDRESS" property="hospitalAddress"/>
		<result column="HOSPITAL_NAME" property="hospitalName"/>
	</resultMap>
	  
	  
	<!-- 캘린더 이벤트 정보 조회 --> 
	<select id="caregiverCalendarEvent" resultMap="calendarResultMap">
		SELECT MAT_NO, '간병하기' AS TITLE, BEGIN_DT, END_DT, MONEY, HOSPITAL_NO, HOSPITAL_ADDRESS, HOSPITAL_NAME 
		FROM MATCHING
		        JOIN HOSPITAL USING(HOSPITAL_NO)
		WHERE MEMBER_NO = #{memberNo}
	</select>

	  <select id="selectAllMember" resultType="Member">		<!-- 멤버좀 확인할라구요 -->
		select *
		from member	  
	  </select>
	  

	  <!-- 회원가입1(member) -->
	  <insert id="enroll"  useGeneratedKeys="true">
	  	<selectKey resultType="_int" keyProperty="memberNo" order="BEFORE">
	  		select seq_mid.nextval from dual 
	  	</selectKey>
	  	insert into member
	  	values(#{memberNo}, #{memberId}, #{memberPwd}, #{memberName}, #{memberGender}, 
	  			#{memberNickName}, #{memberAge}, #{memberPhone}, #{memberEmail}, sysdate,
	  		 	#{memberAddress}, #{memberCategory}, 'N', #{memberNational}, null, sysdate)  	
	  </insert>
	  
	  
	  <!-- 회원가입2(CareGiver) -->
	  <insert id="enrollCareGiver">
	  	insert into caregiver
	  	values(#{memberNo}, #{careImg}, #{careIntro}, 
	  			#{minMoney}, #{maxMoney}, #{careJoinStatus}, #{careService}, sysdate)	  
	  </insert>
	  
	 <!-- 정보 입력-->
	<insert id="enrollInfoCategory">
		<foreach collection="infoCategory" item="item"  open="INSERT ALL" close="SELECT * FROM DUAL">
			into member_Info values(#{memberNo}, #{item})
		</foreach>
	</insert>
	  
	  
	<!-- 회원가입3(Patient) -->
	<insert id="enrollPatient">
	  	insert into patient
	  	values(seq_pid.nextval, #{memberNo}, #{ptName}, #{ptGender}, #{ptAge}, 
	  			#{ptWeight}, #{ptHeight}, #{ptService}, #{ptAddress}, #{ptRequest}, sysdate)	  
	</insert>
	  
	  <select id="findIdResult" resultType="Member">
	  	select member_id,member_create_date,member_status,member_category,member_name
	  	from member
	  	where member_id=#{memberId} and member_phone=#{memberPhone}
	  </select>
	
	<!-- 간병인 메인페이지에서의 자동 추천을 위한 간병인 본인 정보 조회 : 1번 -->
	<select id="getCaregiverInfo" resultType="map">
		SELECT 	DECODE(MEMBER_GENDER, 'M', '남성', 'F', '여성') AS "성별", 
		        EXTRACT(YEAR FROM TO_DATE(SYSDATE, 'RRRR-MM-DD')) - EXTRACT(YEAR FROM TO_DATE(MEMBER_AGE, 'RRRR-MM-DD')) AS "나이",
		        SUBSTR(REPLACE(MEMBER_ADDRESS, '//', ' ') , INSTR(REPLACE(MEMBER_ADDRESS, '//', ' '), ' ')+1) AS "주소",
		        MEMBER_NATIONAL AS "국적",
		        CARE_JOIN_STATUS, MIN_MONEY AS "최소금액"
		FROM MEMBER M
		        JOIN CAREGIVER C ON(M.MEMBER_NO = C.MEMBER_NO) 
		WHERE M.MEMBER_NO = ${memberNo}
	</select>
	<!-- 간병인 메인페이지에서의 자동 추천을 위한 간병인 본인 정보 조회 : 2번 -->
	<select id="getCaregiverExp" resultType="map">
		SELECT L_CATEGORY, S_CATEGORY
		FROM MEMBER
		        JOIN MEMBER_INFO USING(MEMBER_NO)
		        JOIN INFO_CATEGORY USING(CATEGORY_NO)
		WHERE MEMBER_NO = ${memberNo}
	</select>
	
	<!-- 간병인 메인페이지에서의 자동 추천을 위한 환자 후보군의 정보 조회 : 1번 -->
	<select id="selectPatientList" resultType="Patient">
		SELECT *
		FROM   (SELECT  MEMBER.MEMBER_NO, PT_NAME, PT_GENDER,  
		                EXTRACT(YEAR FROM TO_DATE(SYSDATE, 'RRRR-MM-DD')) - EXTRACT(YEAR FROM TO_DATE(MEMBER_AGE, 'RRRR-MM-DD')) AS PT_REAL_AGE, 
		                MEMBER_NATIONAL, PT_WEIGHT, PT_HEIGHT,
		                MAT_NO, BEGIN_DT, END_DT, MONEY,
		                SUBSTR(REPLACE(MAT_ADDRESS_INFO, '//', ' ') , INSTR(REPLACE(MAT_ADDRESS_INFO, '//', ' '), ' ')+1) as PT_ADDRESS, 
		                SERVICE, MAT_REQUEST, PT_COUNT
			   FROM MATCHING 
			        JOIN MAT_PT_INFO USING(MAT_NO)
			        JOIN PATIENT USING(PT_NO)
			        JOIN MEMBER ON(PATIENT.MEMBER_NO = MEMBER.MEMBER_NO)
		   WHERE MEMBER_STATUS = 'N' AND MAT_CONFIRM='N' AND MAT_ADDRESS_INFO LIKE '%${address}%'
		   <if test='joinStatus.equals("N")'>
		   			AND PT_COUNT = 1
		   </if>
		   ORDER BY DBMS_RANDOM.RANDOM)
		WHERE ROWNUM <![CDATA[<]]> ${selectNum}+1
	</select>
	
	<!-- 간병인 메인페이지에서의 자동 추천을 위한 환자 후보군의 정보 조회 : 2번 -->
	<select id="getPatientInfo" resultType="map">
		SELECT MEMBER_NO, L_CATEGORY, S_CATEGORY
		FROM MEMBER
		        JOIN MEMBER_INFO USING(MEMBER_NO)
		        JOIN INFO_CATEGORY USING(CATEGORY_NO)
		WHERE MEMBER_NO IN  
		<foreach collection="list" item="item" open="(" close=")" separator=", ">${item}</foreach>
	</select>
	
	<!-- 추천된 환자 정보조회 : 이름, 성별, 나이, 지역, 금액 -->
	<select id="choicePatientList" resultType="Patient">
		SELECT  PATIENT.MEMBER_NO, PT_NAME, PT_GENDER, PT_NO,  
		        EXTRACT(YEAR FROM TO_DATE(SYSDATE, 'RRRR-MM-DD')) - EXTRACT(YEAR FROM TO_DATE(PT_AGE, 'RRRR-MM-DD')) AS PT_REAL_AGE, 
		        MAT_NO, BEGIN_DT, END_DT, MONEY,
		        SUBSTR(REPLACE(MAT_ADDRESS_INFO, '//', ' ') , INSTR(REPLACE(MAT_ADDRESS_INFO, '//', ' '), ' ')+1) as PT_ADDRESS, 
		        SERVICE, MAT_REQUEST, PT_COUNT
		FROM MATCHING 
		    JOIN MAT_PT_INFO USING(MAT_NO)
		    JOIN PATIENT USING(PT_NO)
	    WHERE MAT_NO IN 
		<foreach collection="list" item="item" open="(" close=")" separator=", ">
			${item}
		</foreach>
	</select>
	
	<!-- 간병인이 원하는 정보조회 -->
	<select id="getCaregiverWant" resultType="map">
		SELECT L_CATEGORY, S_CATEGORY
		FROM MEMBER M
		        JOIN WANT_INFO W ON(M.MEMBER_NO = W.MEMBER_NO)
		        JOIN INFO_CATEGORY I ON(W.CATEGORY_NO = I.CATEGORY_NO)
		WHERE M.MEMBER_NO = ${memberNo}
	</select>	
	
	<!-- 환자 메인 : 환자 본인 정보 조회 1번 -->
	<select id="getPatientMyInfo" resultType="map">
		select DECODE(pt_gender, 'M', '남성', '여성') AS "성별", 
				EXTRACT(YEAR FROM TO_DATE(SYSDATE, 'RRRR-MM-DD')) - EXTRACT(YEAR FROM TO_DATE(MEMBER_AGE, 'RRRR-MM-DD')) AS "연령",
		        SUBSTR(REPLACE(PT_ADDRESS, '//', ' ') , INSTR(REPLACE(PT_ADDRESS, '//', ' '), ' ')+1) as "주소",
		        pt_height AS "키", pt_weight AS "몸무게",
		        member_national AS "국적"
		from member 
		        join patient using(member_no)
		where member_no = ${memberNo}
	</select>
	
	<select id="getPatientMyExp" resultType="map">
		SELECT L_CATEGORY, S_CATEGORY
		FROM MEMBER
		        JOIN MEMBER_INFO USING(MEMBER_NO)
		        JOIN INFO_CATEGORY USING(CATEGORY_NO)
		WHERE MEMBER_NO = ${memberNo}
	</select>
	
	<select id="getCaregiverMyWant" resultType="map">
		SELECT L_CATEGORY, S_CATEGORY
		FROM MEMBER
		        JOIN WANT_INFO USING(MEMBER_NO)
		        JOIN INFO_CATEGORY USING(CATEGORY_NO)
		WHERE MEMBER_NO = ${memberNo}
	</select>
	
	<select id="selectCaregiverList" resultType="map">
		SELECT *
		FROM (  SELECT MEMBER_NO AS "회원번호", DECODE(MEMBER_GENDER, 'M', '남성', '여성') AS "성별", 
		                EXTRACT(YEAR FROM TO_DATE(SYSDATE, 'RRRR-MM-DD')) - EXTRACT(YEAR FROM TO_DATE(MEMBER_AGE, 'RRRR-MM-DD')) AS "연령", 
		                SUBSTR(REPLACE(MEMBER_ADDRESS, '//', ' ') , INSTR(REPLACE(MEMBER_ADDRESS, '//', ' '), ' ')+1) as "주소",
		                MEMBER_NATIONAL AS 국적, MIN_MONEY AS "최소요구금액"
		        FROM MEMBER
		                JOIN CAREGIVER USING(MEMBER_NO)
		        WHERE MEMBER_STATUS = 'N' AND MEMBER_ADDRESS LIKE '%${address}%'
		        ORDER BY DBMS_RANDOM.RANDOM)
		WHERE ROWNUM <![CDATA[<]]> ${selectNum}+1
	</select>
	
	
</mapper>