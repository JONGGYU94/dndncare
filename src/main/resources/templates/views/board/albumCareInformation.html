<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>간병백과 앨범형(사용자)</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <link href="css/careInformation.css" rel="stylesheet" type="text/css"> -->
	<link th:href="@{css/footer.css}" rel="stylesheet" type="text/css"/>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
	<style>
		#careInfomationContainer{display:grid; grid-template-columns:1fr 1280px 1fr;}
	</style>
</head>
<body>
	<div th:replace="~{common/navbar :: navbar}"></div>
	
	<br/><br/><br/><br/><br/><br/><br/><br/><br/>
	
	<div id="careInfomationContainer">
		<div><!-- 왼쪽 공백 --></div>
	
		<div>
			<div id="upperContents" style="display:grid; grid-template-columns: 700px 1fr 400px;">
				<div id="searchContents" style="display:grid; grid-template-columns: 200px 200px 100px 100px;">
					<select class="form-select" name="searchOption">
						<option value="none">검색 유형 선택</option>
						<option value="title">제목</option>
						<option value="content">내용</option>
					</select>
					
					<input type="search" class="form-control" name="searchContent"/>
					<button class="btn btn-primary" type="button" id="searchBtn">검색하기</button>
					<button class="btn btn-warning" type="button" id="selectAllBtn">전체보기</button>
				</div>
				<div><!-- 공백 --></div>
				<div class="text-end">
					<a title="일반형 게시판 보기" href="careInformation.bo"><img src="image/icon/boardIcon.png" id="boardIcon" width="60px" height="60px" alt="일반 게시판"></a>
					<a title="앨범형 게시판 보기" href="albumCareInformation.bo"><img src="image/icon/albumIcon.png" id="albumIcon" alt="앨범형 게시판"></a>
				</div>
			</div>
		
			<table class="table">
				<tbody>
					<tr>
						<td>
							<div class="content" data-bs-toggle="modal" data-bs-target="#exampleModalCenteredScrollable">
			                    <input type="hidden" class="no">
			                    <div class="imgsDiv">
			                        <!-- 첨부파일 미리보기 -->  
			                        <div class="thumbnail d-inline-flex img-border">
			                            <img src="image/icon/deal.png" width="100%"/>
			                        </div> 
			                    </div>
			                    <h3 class="fs-2 text-body-emphasis">글제목<!-- 제목 --></h3>
			                    <p style="height: 50px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;"><!-- 내용 --></p>
			                    <p>
			                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
			                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z"/>
			                        </svg> <span class="writer">글쓴이<!-- 글쓴이 --></span>
			                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar2-event" viewBox="0 0 16 16">
			                            <path d="M11 7.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
			                            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/>
			                            <path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5V4z"/>
			                        </svg> <span class="createDate">작성일<!-- 작성일자 --></span>
			                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
			                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
			                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
			                        </svg> <span class='count'>조회수<!-- 조회수 --></span>
			                    </p>
			                </div>
						</td>
					</tr>
				</tbody>
			
			
			
			</table>
			
		</div>
	
		<div><!-- 오른쪽 공백 --></div>
	</div>
	
	<!--  -->
	<!-- 간병백과 조회용 Scrollable modal (시작) -->
	<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
		    <div class="modal-content">
		    	<div class="modal-header">
			        <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		        </div>
			    <div class="modal-body">
			    	<div class="modal-dialog modal-dialog-scrollable" id="modalContent">
			        
			        </div>
			    </div>
			    <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
			        <!-- <button type="button" class="btn btn-primary">확인</button> -->
			    </div>
		    </div>
		</div>
	</div>
	<!-- 간병백과 조회용 Scrollable modal (끝) -->
	
	
	<div id="footer-section">
	    <div class="inner">
	        <div class="footer-logo">
	            <a href="home.do"><img th:src="@{/image/logo-removebg.png}" alt="로고" id="footer-logo"></a>
	        </div>
	        <div class="column-wrap d-flex">
		        <div class="footer-column">
		            <h3>Project</h3>
		            <p>Title</p>
		            <h6>DnDnCare</h6> 
		            <p>Tell</p>              
		            <h6>02-6959-2159</h6>
		            <p>Address</p>
		            <h6>서울특별시 중구 남대문로 120</h6>
		        </div>
		        <div class="footer-column">
		            <h3>Team Member</h3>
		            <h4>김명훈</h4>               
		            <h4>김종규</h4>
		            <h4>김기룡</h4>  
		            <h4>김남희</h4>
		            <h4>이재영</h4>
		        </div>
		        <div class="footer-column">
		           <h3>Project Info</h3>
				   <h6>KH정보교육원 JAVA개발자 양성 과정</h6>
				   <h6>Final Project</h6>
				   <h6>2024.07.29 - 2024.09.03</h6>
				   <h6>Java, SpringBoot, Oracle, JavaScript</h6>
		        </div>
	        </div>
	        
	    </div>
	    <div class="footer-bottom">
	        <p class="text-center">&copy; 2024 HomeWork. All rights reserved.</p>
	    </div>             
	</div>
	
	<div id="obsTarget"></div>
	
	<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script> -->
	<script th:inline="javascript">
		// 앨볌형인지 구분하기 위한 전역변수 선언 및 초기화
		const isAlbum = true; // 이 화면을 요청할 때 값을 바꿔주고 시작하자.
		
		
		
		// 출력중인 게시글에 대한 정보를 저장해둘 변수를 선언 (시작)
		let presentBoardList = [];
		let presentAttmList = [];
		// 출력중인 게시글에 대한 정보를 저장해둘 변수를 선언 (끝)
		
		// ready 함수 작성
		window.onload = () => {
			const tbody = document.querySelector('tbody'); // 조회결과를 삽입할 요소에 접근
			let defaultPage = 1; // 검색X일 때 사용할 page변수 선언 및 초기화
			let defaultMaxPage; // 검색X일 때 최대 페이지의 수를 저장할 변수 선언
			let searchPage = 1; // 검색O일 때 사용할 page변수 선언 및 초기화
			let searchMaxPage; // 검색O일 때 최대 페이지의 수를 저장할 변수 선언
			let searchFlag = false; // 검색 조회인지 기본 조회인지를 구분하기 위한 깃발 꽂기
			
			// 기본 조회 요청(시작)
			const defaultList = (page) => {
				searchFlag = false;
				$.ajax({
					url: 'selectCareInformationList.bo',
					type: 'post',
					datatype: 'json',
					data: {page: page},
					success: data => {
						//console.log(data); // Object
						if(data != null){
							searchFlag = false;
							let aList = data.aList;
							presentAttmList = [];
							presentAttmList = presentAttmList.concat(aList);
							let bList = data.bList;
							presentBoardList = [];
							presentBoardList = presentBoardList.concat(bList);
							defaultMaxPage = data.pList[0];
							
							// 요소.insertAdjacentHTML() : 보안강화를 위한 연습하기
							for(const board of bList){ // 글번호, 글제목, 작성자, 조회수 를 출력해야한다.
								tbody.insertAdjacentHTML('beforeend', `<tr><td>${board.boardNo}</td><td>${board.boardTitle}</td><td>${board.boardUpdateDate}</td><td>${board.boardCount}</td></tr>`);
							}
							defaultPage++; // 다음 페이지의 숫자를 가르키도록 증가시키기
						}
					},
					error: data => console.log(data)
				});
			}
			// 기본 조회 요청(끝)
			
			// 앨범용 기본 조회 요청(시작)
			
			
			
			
			
			// 앨범용 기본 조회 요청 (끝)
			
			
			
			
			// 페이지 처음 방문 시 출력할 목록 조회(시작)
			if(!isAlbum) {
				defaultList(defaultPage); // 페이지 로드시에 기본으로 실행되어야함
			}
			// 페이지 처음 방문 시 출력할 목록 조회(끝)
			
			// 콜백함수 정의(시작)
			const callback = (entries, observer) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						if(!isAlbum){
							if(!searchFlag && defaultPage <= defaultMaxPage) {
								console.log("일반조회 플래그 : " + searchFlag);
								defaultList(defaultPage); // 기본목록 조회 요청
								console.log("일반조회 요청 페이지 : " + defaultPage);
							} else if(searchFlag && searchPage <= searchMaxPage){
								console.log("검색조회 플래그 : " + searchFlag);
								searchList(searchPage); // 검색목록 조회 요청
								console.log("검색조회 요청 페이지 : " + searchPage);
							}
						} else { // 앨범형일 때 옵저버 기능 코드 작성해야함
							
							
							
							
						}
					}
				});
			}
			// 콜백함수 정의(끝)
			
			// 옵저버 정의 (시작)
			const obsTarget = document.querySelector('#obsTarget');// 관찰 대상을 지정
			let observer = new IntersectionObserver(callback);
			observer.observe(obsTarget);
			// 옵저버 정의 (끝)
		//}
		
		//window.onload = () => {
			//const tbody = document.querySelector('tbody');
			if(!isAlbum){
				tbody.addEventListener('mouseover', function() { // 컨텐츠 목록에 마우스 오버시 손가락 포인터로 변경
					if(tbody.children[0].children[0].innerText != '검색결과가 존재하지 않습니다.'){
						this.style.cursor = 'pointer';
					}
				})
				
				
				const modalTitle = document.querySelector('#staticBackdropLabel'); // 글 상세조회 모달의 제목 요소에 접근
				const modalContent = document.querySelector('#modalContent'); // 글 상세조회 모달의 내용 요소에 접근
				
				tbody.addEventListener('click', function(event) { // 컨텐츠 목록을 마우스 클릭할 때 게시글 정보를 모달창으로 출력하자
					// 해당 글 번호에 접근 => 글 번호가 일치하는 정보에 접근 => 데이터 뿌리기
					
					//this.children[0].style.background = 'red'; // 여기여기 문제발생!
					//this.children[0].children[0].style.background = 'red'; // **
					//console.log(this);
					
					const bNo = event.target.parentElement.children[0].innerText;
					let bCountTd = event.target.parentElement.children[3];
					let clickBoard; // 클릭한 글에 대한 데이터에 접근
					const clickNoThumbNailList = []; // 클릭한 글에 대한 첨부파일에 접근
					let clickThumbnail; // 클릭한 글에 대한 썸네일을 저장할 지역변수
					
					for(const board of presentBoardList){
						if(board.boardNo == bNo) {
							clickBoard = board;
							break;
						}
					}
					
					for(const attm of presentAttmList){
						if(attm.refBoardNo == bNo){
							if(attm.attmLevel != 0) {
								clickNoThumbNailList.push(attm);
							} else{
								clickThumbnail = attm;
							}
						}
					}
					
					
					// 조회수 증가 : 로그인한 유저와 글 작성자가 다를 때만 동작해야 한다. (시작)
					/*<![CDATA[*/
					if(/*[[session.loginUser.memberNo]]*/0 != clickBoard.memberNo){
						//console.log(tbody.children[0].children[0].innerText);
						if(tbody.children[0].children[0].innerText != '검색결과가 존재하지 않습니다.'){
							$.ajax({
								url: 'updateCareInformationCount.bo',
								data: {boardNo: clickBoard.boardNo},
								success: data => {
									console.log(data);
									
									if(data == 'success'){ // 조회수 증가 성공 : 현재 View에서 조회수를 업데이트해야 한다.
										// table에서 해당 글에 대한 tr에 접근 => 조회수 +1 시키자.
										for(const present of presentBoardList){
											if(present.boardNo == bNo){ // 클릭한 글에 대한 정보를 전역변수에서 최신화한다.
												present.boardCount += 1; 
												bCountTd.innerText = present.boardCount; 
												break;
											}
										}
									} else{
										alert('서비스 요청에 실패하였습니다.');
										location.reload();
									}
								},
								error: data => console.log(data)
							});
							
							modalTitle.innerText = clickBoard.boardTitle;
							
							modalContent.innerHTML = '';
							if(clickThumbnail != undefined) {
								modalContent.insertAdjacentHTML('afterbegin', `<img src=${clickThumbnail.renameName}><br/>`);
							}
							modalContent.insertAdjacentHTML('beforeend', clickBoard.boardContent);
							
							$('#staticBackdrop').modal('show'); 
						}
					}
					/*]]>*/
					// 조회수 증가 (끝)
				}
			})
			
			
			// 앨범형 아이콘 클릭(시작) : 컨텐츠 출력하는 구조가 달라지기 때문에 별도의 페이지로 제작하는 것이 안전할 것이라고 생각됨
			// 앨범형 아이콘 클릭(끝)
			
			
			// 검색 요청 함수 정의(시작)
			/*<![CDATA[*/
			let aiCount = /*[[${aiCount}]]*/'aiCount';	 // 사용자의 ai검색 요청 횟수
			/*]]>*/	
			const searchOption = document.getElementsByName('searchOption')[0];
			const optionList = searchOption.children;
			const searchContent = document.getElementsByName('searchContent')[0];
			
			const searchList = (page) => {
				searchFlag = true;
				$.ajax({
					url: 'searchCareInformation.bo',
					datatype: 'json',
					data: {
						searchOption: searchOption.value,
						searchContent: searchContent.value,
						page: page
					},
					success: data => {
						console.log("검색한 data :");
						console.log(data);
						if(data != null && data != 'empty'){
							let aList = data.aList;
							presentAttmList = [];
							presentAttmList = presentAttmList.concat(aList);
							let bList = data.bList;
							presentBoardList = [];
							presentBoardList = presentBoardList.concat(bList);
							searchMaxPage = data.pList[0];
							
							// 요소.insertAdjacentHTML() : 보안강화를 위한 연습하기
							tbody.innerHTML = '';
							for(const board of bList){ // 글번호, 글제목, 작성자, 조회수 를 출력해야한다.
								tbody.insertAdjacentHTML('beforeend', `<tr><td>${board.boardNo}</td><td>${board.boardTitle}</td><td>${board.boardUpdateDate}</td><td>${board.boardCount}</td></tr>`);
							}
							
							searchPage++;
						} else if(data == 'empty'){
							tbody.innerHTML = '';
							tbody.insertAdjacentHTML('beforeend', `<tr><td>검색결과가 존재하지 않습니다.</td><td></td><td></td><td></td></tr>`);
							
							let codition = searchOption.value == 'title' ? '제목' : '내용';
							document.querySelector('#confirmModalBody').innerHTML = `<span style="color: red;">'${codition}'</span>이 <span style="color: red;">'${searchContent.value}'</span>인 글이 존재하지 않습니다.<br/>Ai에게 질문하시겠습니까?<span style="color: red;">(${3-aiCount}회 남음)</span>`;
							document.querySelector('#confirmYes').previousElementSibling.value = searchContent.value;
							if(aiCount >= 3) {
								document.querySelector('#confirmYes').disabled = true; // 검색횟수가 3회이상일 때는 추가검색 버튼을 비활성화
							}
							
							$('#confirmModal').modal('show');
						}
					},
					error: data => console.log(data)
				});
			}
			// 검색 요청 함수 정의(끝)
			
			
			// 검색 기능 (시작)
			document.querySelector('#searchBtn').addEventListener('click', () => {
				if(optionList[0].selected){ // 검색옵션을 선택하지 않은 상태일 때
					searchContent.value = ''; // 검색내용을 초기화
					alert('검색 유형을 선택해주세요.'); 
				} else if(searchContent.value.trim() == ''){ // 검색내용을 입력하지 않은 상태일 때
					searchContent.value = ''; // 검색내용을 초기화
					alert('검색 내용을 입력해주세요.');
				} else { // 검색 옵션을 선택하고 검색내용을 입력한 상태일 때
					if(!isAlbum) {
						searchPage = 1; // 반복하여 검색했을 때 페이지의 수를 1로 초기화해야 한다.
						searchList(searchPage);
					} else { // 앨범형일 때 검색 목록 출력을 요청해야한다.
						
						
						
						
						
					}
				}
			});
			// 검색 기능 (끝)
			
			// 전체보기 버튼 기능 (시작)
			document.querySelector('#selectAllBtn').addEventListener('click', () => {
				if(!isAlbum){
					defaultPage = 1;
					defaultList(defaultPage);
				} else{ // 앨범형일 때 코드 작성
					
					
					
					
				}
			});
			// 전체보기 버튼 기능 (끝)
			
			// ai추가 검색 (시작)
			document.querySelector('#confirmYes').addEventListener('click', function() {
				aiCount++;
				
				let condition = this.previousElementSibling.value;
				$.ajax({
					url: 'searchOpenAi.bo',
					data: {condition: condition},
					success: data => {
						console.log(data);
						
						document.querySelector('#answerModalLabel').insertAdjacentHTML('afterbegin', `${condition}에 대한 AI 검색결과`);
						document.querySelector('#answerModalContent').insertAdjacentHTML('afterbegin', data);
						$('#confirmModal').modal('hide');
						$('#answerModal').modal('show');
					},
					error: data => console.log(data)
				});
			});
			// ai추가 검색 (끝)
		}
	</script>
	
	
	
</body>
</html>